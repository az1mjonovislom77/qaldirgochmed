
name: Deploy Django to VPS

on:
 workflow_run:
   workflows: ["CI - Django Checks"]
   types:
     - completed

jobs:
 deploy:
   if: ${{ github.event.workflow_run.conclusion == 'success' }}
   runs-on: ubuntu-latest

   steps:
     - name: Deploy via SSH
       uses: appleboy/ssh-action@v1.0.3
       with:
         host: ${{ secrets.VPS_HOST }}
         username: ${{ secrets.VPS_USER }}
         key: ${{ secrets.VPS_SSH_KEY }}
         script: |
           set -e

           cd ${{ secrets.PROJECT_PATH }}

           git config --global --add safe.directory /home/qaldirgochmed


           echo "ğŸ“¥ Pulling latest code..."
           git pull origin main

           echo "ğŸ Activating venv..."
           source venv/bin/activate

           echo "ğŸ“¦ Installing requirements..."
           pip install -r requirements.txt

           echo "ğŸ§± Running migrations..."
           python3 manage.py migrate --noinput

           echo "ğŸ¨ Collecting static files..."
           python3 manage.py collectstatic --noinput

           echo "ğŸ”„ Restarting services..."
           sudo systemctl restart ${{ secrets.SERVICE_NAME }}
           sudo systemctl restart nginx

           echo "âœ… Deploy finished!"
